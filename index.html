<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers Médicaux</title>

<link rel="icon" href="https://i.imgur.com/ZtAo0te.png">

<style>
body{
  background:#0d1117;
  color:white;
  font-family:Arial;
  padding:20px;
}
h2{
  display:flex;
  align-items:center;
  gap:10px;
}
button{
  background:#238636;
  color:white;
  border:none;
  padding:8px;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#2ea043}
input,select,textarea{
  width:100%;
  padding:8px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #30363d;
  background:#0d1117;
  color:white;
}
textarea{resize:none;height:70px}

.dossier{
  background:#161b22;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
}

.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}
.box{
  background:#161b22;
  padding:20px;
  width:520px;
  max-height:85vh;
  overflow:auto;
  border-radius:12px;
}

.entry{
  padding:8px;
  border-radius:6px;
  margin-top:6px;
  font-size:14px;
}
.soin{background:#7d1f1f}
.vaccin{background:#1f3f7d}
.visite{background:#1f7d3a}

.loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
}
.loading img{
  width:120px;
}
</style>
</head>

<body>

<h2>
  <img src="https://i.imgur.com/ZtAo0te.png" width="40">
  Dossiers Médicaux
</h2>

<!-- BOUTON CRÉATION (MEDIC SEULEMENT) -->
<div id="createZone"></div>

<div id="list"></div>

<!-- POPUP DOSSIER -->
<div class="popup" id="popup">
  <div class="box">
    <h3 id="popName"></h3>
    <img id="popImg" width="150"><br><br>

    <div id="entries"></div>
    <div id="addZone"></div>

    <button onclick="closePop()">Fermer</button>
  </div>
</div>

<!-- POPUP CRÉATION DOSSIER -->
<div class="popup" id="createPop">
  <div class="box">
    <h3>Créer un dossier médical</h3>

    <input id="c_nom" placeholder="Nom de la personne">
    <input id="c_discord" placeholder="ID Discord lié">
    <input id="c_photo" placeholder="URL Imgur (carte d'identité)">

    <button onclick="createDossier()">Créer le dossier</button>
    <button onclick="closeCreate()">Annuler</button>
  </div>
</div>

<!-- LOADING -->
<div class="loading" id="loading">
  <img src="https://www.pngmart.com/files/23/Loading-PNG-Photos.gif">
</div>

<script>
const WEB_APP = "https://script.google.com/macros/s/AKfycbwdBvKtH8-PWY8ofofan8v9qJXLDrmztzAODRmgpj3qDSLWvB60SJY1lCYpLMLavu4/exec";
const mode = localStorage.mode || "medic";
const user = localStorage.user || "inconnu";
const nomCivil = localStorage.nomCivil || "";

let dossiers = [];

/* ===== JSONP ===== */
function jsonp(p){
  return new Promise(r=>{
    const cb="cb_"+Math.random().toString(36).substring(2);
    p.callback=cb;
    window[cb]=d=>{r(d);delete window[cb];s.remove();}
    const s=document.createElement("script");
    s.src=WEB_APP+"?"+new URLSearchParams(p);
    document.body.appendChild(s);
  });
}

/* ===== LOADING ===== */
function showLoading(){
  loading.style.display="flex";
  setTimeout(()=>location.reload(),2000);
}

/* ===== LOAD ===== */
async function load(){
  dossiers = await jsonp({action:"list"});
  list.innerHTML="";

  if(mode==="medic"){
    createZone.innerHTML = `
      <button onclick="openCreate()">➕ Créer un dossier médical</button>
      <br><br>
    `;
  }

  dossiers.forEach(d=>{
    if(mode==="civil" && d.nom!==nomCivil) return;

    list.innerHTML += `
      <div class="dossier" onclick="openPop('${d.id}')">
        ${d.nom}
      </div>
    `;
  });

  if(mode==="civil"){
    const d = dossiers.find(x=>x.nom===nomCivil);
    if(d) openPop(d.id);
  }
}

/* ===== POP DOSSIER ===== */
function openPop(id){
  const d = dossiers.find(x=>x.id==id);
  popName.innerText = d.nom;
  popImg.src = d.photo;
  entries.innerHTML="";

  d.entries.forEach(e=>{
    entries.innerHTML+=`
      <div class="entry ${e.type}">
        <b>${e.type.toUpperCase()}</b><br>
        ${e.texte}<br>
        <small>${e.auteur} – ${e.date}</small>
      </div>
    `;
  });

  if(mode==="medic"){
    addZone.innerHTML=`
      <select id="type">
        <option value="soin">Fait de soin</option>
        <option value="vaccin">Vaccin</option>
        <option value="visite">Visite médicale</option>
      </select>
      <textarea id="text" placeholder="Détails"></textarea>
      <button onclick="add('${id}')">Ajouter</button>
    `;
  }else addZone.innerHTML="";

  popup.style.display="flex";
}

function closePop(){ popup.style.display="none"; }

/* ===== CREATE DOSSIER ===== */
function openCreate(){ createPop.style.display="flex"; }
function closeCreate(){ createPop.style.display="none"; }

function createDossier(){
  jsonp({
    action:"new",
    nom:c_nom.value,
    discord:c_discord.value,
    photo:c_photo.value
  }).then(showLoading);
}

/* ===== ADD ENTRY ===== */
function add(id){
  jsonp({
    action:"add",
    id,
    type:type.value,
    text:text.value,
    user:user
  }).then(showLoading);
}

load();
</script>

</body>
</html>
