<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers M√©dicaux</title>

<link rel="icon" href="https://i.imgur.com/ZtAo0te.png">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}

header{
  background:#020617;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header-left{display:flex;align-items:center;gap:15px}
.header-left img{width:45px}

.container{padding:25px}

button{
  background:#2563eb;
  color:white;
  border:none;
  padding:10px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
button:disabled{opacity:.6}

input,select,textarea{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  margin-bottom:10px;
}

.card{
  background:#020617;
  padding:20px;
  border-radius:14px;
  margin-bottom:20px;
  box-shadow:0 0 20px rgba(0,0,0,.4);
}

.entry{
  border-left:5px solid;
  padding:10px;
  margin-top:10px;
}
.soin{border-color:#dc2626}
.vaccin{border-color:#16a34a}
.visite{border-color:#ca8a04}

.badge{
  font-size:12px;
  font-weight:bold;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:#020617;
  padding:25px;
  width:400px;
  border-radius:14px;
}
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="https://i.imgur.com/ZtAo0te.png">
    <div id="status"></div>
  </div>
  <button onclick="logout()">D√©connexion</button>
</header>

<div class="container">
  <input id="search" placeholder="üîé Rechercher un dossier" oninput="render()">

  <button id="newBtn" onclick="openCreate()">‚ûï Nouveau dossier</button>

  <div id="list"></div>
</div>

<!-- MODAL CR√âATION DOSSIER -->
<div class="modal" id="createModal">
  <div class="modal-content">
    <h3>Nouveau dossier m√©dical</h3>
    <input id="newNom" placeholder="Nom Pr√©nom">
    <input id="newPhoto" placeholder="Lien Imgur carte ID">
    <input id="newDiscord" placeholder="ID Discord">
    <button onclick="createDossier()">Cr√©er</button>
    <button onclick="closeCreate()">Annuler</button>
  </div>
</div>

<!-- MODAL AJOUT -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>Ajouter une entr√©e</h3>

    <select id="type" onchange="changeForm()"></select>

    <div id="form"></div>

    <button onclick="submitEntry()">Enregistrer</button>
    <button onclick="closeAdd()">Annuler</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbym1G5HzrOmRPn0_33SZXpshUzNitMh2DOzDNDCYUSsx83aGG93WuFPvdPwhV3Mhn_Y/exec";

const user=localStorage.getItem("user");
const permission=localStorage.getItem("permission");
const viewer=localStorage.getItem("viewer");

let dossiers=[], current=null;

if(!user&&!viewer) location.href="login.html";
status.innerText=viewer?"üëÅÔ∏è Consultation citoyen":`ü©∫ ${user} (${permission})`;

newBtn.style.display=permission?"inline-block":"none";

fetch(API,{method:"POST",body:JSON.stringify({action:"list"})})
.then(r=>r.json()).then(d=>{dossiers=d;render();});

function render(){
  list.innerHTML="";
  dossiers.filter(d=>d.nom.toLowerCase().includes(search.value.toLowerCase()))
  .forEach(d=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h2>${d.nom}</h2>
      <img src="${d.photo}" width="180"><br><br>

      ${d.entries.map(e=>{
        let c=e.contenu;
        return `
        <div class="entry ${e.type}">
          <span class="badge">${e.type.toUpperCase()}</span><br>
          ${Object.entries(c).map(([k,v])=>`${k} : ${v}`).join("<br>")}
          <br><i>Ajout√© par : ${e.auteur}</i>
        </div>`;
      }).join("")}

      ${permission?`<br><button onclick="openAdd('${d.nom}')">‚ûï Ajouter une entr√©e</button>`:""}
    `;
    list.appendChild(div);
  });
}

function openCreate(){createModal.style.display="flex"}
function closeCreate(){createModal.style.display="none"}

function createDossier(){
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"create",
    nom:newNom.value,
    photo:newPhoto.value,
    discord:newDiscord.value
  })}).then(()=>location.reload());
}

function openAdd(nom){
  current=nom;
  addModal.style.display="flex";

  type.innerHTML="";
  type.add(new Option("Faits de soin","soin"));
  if(permission==="medic-chef"){
    type.add(new Option("Vaccin","vaccin"));
    type.add(new Option("Visite m√©dicale","visite"));
  }
  changeForm();
}

function closeAdd(){addModal.style.display="none"}

function changeForm(){
  if(type.value==="soin"){
    form.innerHTML=`
      <textarea id="b" placeholder="Blessures"></textarea>
      <textarea id="i" placeholder="Interventions"></textarea>
      <input id="inv" placeholder="Temps d'invalidation (optionnel)">
    `;
  }
  if(type.value==="vaccin"){
    form.innerHTML=`
      <input id="n" placeholder="Nom vaccin">
      <input id="d" placeholder="Dose">
      <input id="but" placeholder="But">
    `;
  }
  if(type.value==="visite"){
    form.innerHTML=`
      <input id="m" placeholder="M√©decin">
      <input id="date" type="date">
      <select id="e"><option>Positive</option><option>N√©gative</option></select>
    `;
  }
}

function submitEntry(){
  let contenu={};
  if(type.value==="soin")
    contenu={blessures:b.value,interventions:i.value,invalidation:inv.value};
  if(type.value==="vaccin")
    contenu={nom:n.value,dose:d.value,but:but.value};
  if(type.value==="visite")
    contenu={medecin:m.value,date:date.value,evaluation:e.value};

  fetch(API,{method:"POST",body:JSON.stringify({
    action:"add",
    nom:current,
    type:type.value,
    contenu,
    auteur:user
  })}).then(()=>location.reload());
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
