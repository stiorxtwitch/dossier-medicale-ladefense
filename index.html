<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers M√©dicaux</title>

<style>
body{background:#0d1117;color:white;font-family:Arial;padding:20px}
button{background:#238636;color:white;border:none;padding:8px;border-radius:6px;cursor:pointer}
button:hover{background:#2ea043}
input,textarea,select{
  width:100%;padding:8px;margin:5px 0;
  background:#0d1117;color:white;
  border:1px solid #30363d;border-radius:6px
}
textarea{resize:none;height:70px}

.dossier{background:#161b22;padding:12px;border-radius:10px;margin-bottom:10px;cursor:pointer}

.popup,.loading{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;justify-content:center;align-items:center;z-index:10
}
.box{
  background:#161b22;padding:20px;
  width:520px;max-height:85vh;
  overflow:auto;border-radius:12px
}

.entry{padding:8px;border-radius:6px;margin-top:6px;font-size:14px}
.soin{background:#7d1f1f}
.vaccin{background:#1f3f7d}
.visite{background:#1f7d3a}

.loading img{width:120px}
</style>
</head>

<body>

<h2>Dossiers M√©dicaux</h2>

<div id="createZone"></div>
<div id="list"></div>

<div class="popup" id="popup">
  <div class="box">
    <h3 id="popName"></h3>
    <img id="popImg" width="150"><br><br>

    <div id="entries"></div>
    <div id="addZone"></div>

    <button onclick="closePop()">Fermer</button>
  </div>
</div>

<div class="popup" id="createPop">
  <div class="box">
    <h3>Cr√©er un dossier m√©dical</h3>
    <input id="c_nom" placeholder="Nom de la personne">
    <input id="c_discord" placeholder="ID Discord li√©">
    <input id="c_photo" placeholder="URL Imgur (CI)">
    <button onclick="createDossier()">Cr√©er</button>
    <button onclick="closeCreate()">Annuler</button>
  </div>
</div>

<div class="loading" id="loading">
  <img src="https://www.pngmart.com/files/23/Loading-PNG-Photos.gif">
</div>

<script>
const WEB_APP="https://script.google.com/macros/s/AKfycbwdBvKtH8-PWY8ofofan8v9qJXLDrmztzAODRmgpj3qDSLWvB60SJY1lCYpLMLavu4/exec";

/* üîê NORMALISATION ROLE */
let rawRole = (localStorage.role || localStorage.mode || "civil").toLowerCase();

let role = "civil";
if(rawRole.includes("chef")) role = "medic-chef";
else if(rawRole.includes("medic")) role = "medic";

const user = localStorage.user || "Inconnu";
const nomCivil = localStorage.nomCivil || "";

let dossiers=[];

/* JSONP */
function jsonp(p){
  return new Promise(r=>{
    const cb="cb"+Math.random().toString(36).slice(2);
    p.callback=cb;
    window[cb]=d=>{r(d);delete window[cb];s.remove();}
    const s=document.createElement("script");
    s.src=WEB_APP+"?"+new URLSearchParams(p);
    document.body.appendChild(s);
  });
}

function showLoading(){
  loading.style.display="flex";
  setTimeout(()=>location.reload(),2000);
}

/* LOAD */
async function load(){
  dossiers=await jsonp({action:"list"});
  list.innerHTML="";
  createZone.innerHTML="";

  if(role!=="civil"){
    createZone.innerHTML=`<button onclick="openCreate()">‚ûï Cr√©er un dossier m√©dical</button><br><br>`;
  }

  dossiers.forEach(d=>{
    if(role==="civil" && d.nom!==nomCivil) return;
    list.innerHTML+=`<div class="dossier" onclick="openPop('${d.id}')">${d.nom}</div>`;
  });

  if(role==="civil"){
    const d=dossiers.find(x=>x.nom===nomCivil);
    if(d) openPop(d.id);
  }
}

function openPop(id){
  const d=dossiers.find(x=>x.id==id);
  popName.innerText=d.nom;
  popImg.src=d.photo;
  entries.innerHTML="";

  d.entries.forEach(e=>{
    entries.innerHTML+=`
      <div class="entry ${e.type}">
        <b>${e.type.toUpperCase()}</b><br>${e.texte}<br>
        <small>${e.auteur} ‚Äì ${e.date}</small>
      </div>`;
  });

  if(role!=="civil") renderForm(id);
  else addZone.innerHTML="";

  popup.style.display="flex";
}

function renderForm(id){
  let options=`<option value="soin">Soins</option>`;

  if(role==="medic-chef"){
    options+=`
      <option value="vaccin">Vaccin</option>
      <option value="visite">Visite m√©dicale</option>
    `;
  }

  addZone.innerHTML=`
    <select id="type" onchange="formChange()">${options}</select>
    <div id="form"></div>
    <button onclick="send('${id}')">Ajouter</button>
  `;
  formChange();
}

function formChange(){
  const t=type.value;
  if(t==="vaccin"){
    form.innerHTML=`
      <input id="v_nom" placeholder="Nom du vaccin">
      <input id="v_dose" placeholder="N¬∞ Dose">
      <input id="v_but" placeholder="But du vaccin">
    `;
  }
  if(t==="soin"){
    form.innerHTML=`
      <textarea id="s_soin" placeholder="R√©capitulatif des soins"></textarea>
      <textarea id="s_blessure" placeholder="R√©capitulatif des blessures"></textarea>
      <input id="s_time" placeholder="Invalidation (optionnel)">
    `;
  }
  if(t==="visite"){
    form.innerHTML=`
      <input id="m_doctor" placeholder="Nom du docteur">
      <select id="m_result">
        <option value="POSITIF">Positif</option>
        <option value="NEGATIF">N√©gatif</option>
      </select>
    `;
  }
}

function send(id){
  let text="";
  if(type.value==="vaccin"){
    text=`Vaccin: ${v_nom.value}\nDose: ${v_dose.value}\nBut: ${v_but.value}`;
  }
  if(type.value==="soin"){
    text=`Soins: ${s_soin.value}\nBlessures: ${s_blessure.value}`;
    if(s_time.value) text+=`\nInvalidation: ${s_time.value}`;
  }
  if(type.value==="visite"){
    text=`Docteur: ${m_doctor.value}\nR√©sultat: ${m_result.value}`;
  }

  jsonp({
    action:"add",
    id,
    type:type.value,
    text,
    user
  }).then(showLoading);
}

function openCreate(){createPop.style.display="flex";}
function closeCreate(){createPop.style.display="none";}

function createDossier(){
  jsonp({
    action:"new",
    nom:c_nom.value,
    discord:c_discord.value,
    photo:c_photo.value
  }).then(showLoading);
}

function closePop(){popup.style.display="none";}

load();
</script>

</body>
</html>
