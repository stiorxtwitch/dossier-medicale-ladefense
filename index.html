<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers MÃ©dicaux</title>
<style>
body {
  margin:0;
  font-family:Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
}
header {
  background:#020617;
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container {
  padding:20px;
}
.card {
  background:#020617;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
button {
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}
.tag {
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.soin { background:#dc2626; }
.vaccin { background:#16a34a; }
.visite { background:#ca8a04; }
</style>
</head>
<body>

<header>
  <div id="status"></div>
  <button onclick="logout()">DÃ©connexion</button>
</header>

<div class="container">
  <input id="search" placeholder="ðŸ”Ž Rechercher un dossier" oninput="render()">
  <button onclick="newDossier()">âž• Nouveau dossier</button>
  <div id="list"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyeo31L1H09ZbPy2AOmty1cYWbz_ffU1pAH0C9S6MjjNPdkw0rSCrKUCm9uFRsPVKaL/exec";

const user = localStorage.getItem("user");
const permission = localStorage.getItem("permission");
const viewer = localStorage.getItem("viewer");

let dossiers = [];

if(!user && !viewer) location.href="login.html";

status.innerText = viewer
  ? "ðŸ‘ï¸ Consultation citoyen (lecture seule)"
  : `ConnectÃ© : ${user} (${permission})`;

if(viewer){
  dossiers = JSON.parse(viewer);
  render();
}else{
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"list"})
  })
  .then(r=>r.json())
  .then(d=>{
    dossiers = d;
    render();
  });
}

function render(){
  list.innerHTML="";
  const q = search.value.toLowerCase();
  dossiers.filter(d=>d.nom.toLowerCase().includes(q))
  .forEach(d=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h3>${d.nom}</h3>
      <img src="${d.photo}" width="200"><br><br>
      ${d.entries.map(e=>`
        <span class="tag ${e.type}">${e.type}</span>
        <b>${e.auteur}</b><br>
        ${e.contenu}<hr>
      `).join("")}
      ${viewer?"":`<button onclick="addEntry('${d.id}')">âž• Ajouter</button>`}
    `;
    list.appendChild(div);
  });
}

function newDossier(){
  if(viewer) return;
  const nom = prompt("Nom");
  const photo = prompt("Lien Imgur");
  const webhook = prompt("Webhook Discord");
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"new", nom, photo, webhook})
  }).then(()=>location.reload());
}

function addEntry(id){
  const type = prompt("Faits de soin / Vaccin / Visite MÃ©dicale");
  let data = {action:"add", id, type, auteur:user};

  if(type==="Faits de soin"){
    data.blessures = prompt("RÃ©sumÃ© blessures");
    data.interventions = prompt("RÃ©sumÃ© interventions");
    data.invalidation = prompt("Temps d'invalidation");
  }
  if(type==="Vaccin"){
    if(permission!=="medic-chef") return alert("RÃ©servÃ© medic-chef");
    data.vaccin = prompt("Nom vaccin");
    data.dose = prompt("Dose");
    data.but = prompt("But");
  }
  if(type==="Visite MÃ©dicale"){
    if(permission!=="medic-chef") return alert("RÃ©servÃ© medic-chef");
    data.medecin = prompt("Nom du mÃ©decin");
    data.date = prompt("Date");
    data.eval = prompt("Positive / NÃ©gative");
  }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(data)
  }).then(()=>location.reload());
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
