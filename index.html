<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers Médicaux</title>
<link rel="icon" href="https://i.imgur.com/ZtAo0te.png">
<style>
body{margin:0;background:#0e1117;color:white;font-family:Arial}
header{
  background:#161b22;
  padding:15px;
  display:flex;
  align-items:center;
  gap:15px;
}
button{
  background:#238636;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:5px;
  cursor:pointer;
}
.card{
  background:#161b22;
  margin:15px;
  padding:15px;
  border-radius:10px;
}
.entry{
  background:#0e1117;
  padding:8px;
  margin:5px 0;
  border-left:4px solid #238636;
}
</style>
</head>
<body>

<header>
  <img src="https://i.imgur.com/ZtAo0te.png" width="40">
  <h2>Dossiers Médicaux</h2>
  <button onclick="newDossier()">+ Nouveau dossier</button>
</header>

<div id="list"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzvaXkIvVMv42UCmKeOlYJknf-mYENumbDlAJdvwxtEvid2fS3NDsoqL4HOgu1kfBWD/exec";
const perm = localStorage.getItem("perm");
const user = localStorage.getItem("user");
const viewer = localStorage.getItem("viewer");

function api(p){
  return fetch(API+"?"+new URLSearchParams(p)).then(r=>r.json());
}

function load(){
  api({action:"list"}).then(d=>{
    list.innerHTML="";
    d.forEach(ds=>{
      if(viewer && ds.nom!==viewer) return;
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <h3>${ds.nom}</h3>
        <img src="${ds.photo}" width="120"><br>
        ${(perm?"<button onclick=\"add('"+ds.id+"')\">Ajouter</button>":"")}
      `;
      ds.entries.forEach(e=>{
        div.innerHTML+=`
          <div class="entry">
            <b>${e.type}</b> — ${e.auteur}<br>
            ${JSON.stringify(e.data)}<br>
            <small>${e.date}</small>
          </div>`;
      });
      list.appendChild(div);
    });
  });
}

function newDossier(){
  const nom=prompt("Nom Prénom");
  const photo=prompt("Lien Imgur");
  const discord=prompt("ID Discord");
  api({
    action:"new",
    nom, photo, discord
  }).then(load);
}

function add(id){
  const type=prompt("Type (soin/vaccin/visite)");
  const data=prompt("Données");
  api({
    action:"add",
    id,
    type,
    auteur:user,
    data
  }).then(load);
}

load();
</script>
</body>
</html>
