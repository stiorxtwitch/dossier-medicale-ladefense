<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers M√©dicaux</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
}
header{
  background:#020617;
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{padding:20px}
.card{
  background:#020617;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}
button{
  background:#2563eb;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}
input, select, textarea{
  width:100%;
  margin-top:6px;
  padding:8px;
  border-radius:6px;
  border:none;
}
textarea{resize:vertical}
.tag{
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
}
.soin{background:#dc2626}
.vaccin{background:#16a34a}
.visite{background:#ca8a04}
.hidden{display:none}
hr{border:0;border-top:1px solid #334155;margin:10px 0}
</style>
</head>

<body>

<header>
  <div id="status"></div>
  <button onclick="logout()">D√©connexion</button>
</header>

<div class="container">

  <input id="search" placeholder="üîé Rechercher un dossier" oninput="render()">
  <br><br>
  <button onclick="showNewDossier()">‚ûï Nouveau dossier</button>

  <!-- NOUVEAU DOSSIER -->
  <div id="newDossier" class="card hidden">
    <h3>Nouveau dossier m√©dical</h3>
    <input id="nd_nom" placeholder="Nom Pr√©nom">
    <input id="nd_photo" placeholder="Lien Imgur carte d'identit√©">
    <input id="nd_discord" placeholder="ID Discord">
    <button onclick="createDossier()">Cr√©er</button>
  </div>

  <div id="list"></div>

</div>

<!-- FORMULAIRE AJOUT -->
<div id="formEntry" class="card hidden">
  <h3>Ajouter une entr√©e</h3>

  <select id="entryType" onchange="switchForm()">
    <option value="">-- S√©lectionner --</option>
    <option value="soin">Faits de soin</option>
    <option value="vaccin">Vaccin</option>
    <option value="visite">Visite m√©dicale</option>
  </select>

  <!-- SOIN -->
  <div id="formSoin" class="hidden">
    <textarea id="blessures" placeholder="R√©sum√© des blessures"></textarea>
    <textarea id="interventions" placeholder="R√©sum√© des interventions"></textarea>
    <input id="invalidation" placeholder="Temps d'invalidation (optionnel)">
  </div>

  <!-- VACCIN -->
  <div id="formVaccin" class="hidden">
    <input id="vaccin_nom" placeholder="Nom du vaccin">
    <input id="vaccin_dose" placeholder="N¬∞ de dose">
    <input id="vaccin_but" placeholder="But">
  </div>

  <!-- VISITE -->
  <div id="formVisite" class="hidden">
    <input id="visite_medecin" placeholder="Nom du m√©decin">
    <input id="visite_date" placeholder="Date">
    <select id="visite_eval">
      <option value="">√âvaluation</option>
      <option value="positive">Positive</option>
      <option value="n√©gative">N√©gative</option>
    </select>
  </div>

  <br>
  <button onclick="submitEntry()">Enregistrer</button>
  <button onclick="closeForm()">Annuler</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyuOiBP0pv6cKeHIYVPGaq-MaMVU0nL64eg_Kxoict3H8YE6zx16-oefEPLuX8IbTw4/exec";

const user = localStorage.getItem("user");
const permission = localStorage.getItem("permission");
const viewer = localStorage.getItem("viewer");

let dossiers = [];
let currentDossier = null;

if(!user && !viewer) location.href="login.html";

status.innerText = viewer
 ? "üëÅÔ∏è Consultation citoyen (lecture seule)"
 : `ü©∫ ${user} (${permission})`;

if(viewer){
 dossiers = JSON.parse(viewer);
 render();
}else{
 fetch(API,{method:"POST",body:JSON.stringify({action:"list"})})
 .then(r=>r.json()).then(d=>{dossiers=d;render();});
}

function render(){
 list.innerHTML="";
 const q = search.value.toLowerCase();
 dossiers.filter(d=>d.nom.toLowerCase().includes(q))
 .forEach(d=>{
   const div=document.createElement("div");
   div.className="card";
   div.innerHTML=`
     <h3>${d.nom}</h3>
     <img src="${d.photo}" width="200"><hr>
     ${d.entries.map(e=>`
       <span class="tag ${e.type}">${e.type}</span>
       <b>${e.auteur}</b><br>
       ${JSON.stringify(e.contenu)}<hr>
     `).join("")}
     ${viewer?"":`<button onclick="openForm('${d.id}')">‚ûï Ajouter une entr√©e</button>`}
   `;
   list.appendChild(div);
 });
}

function showNewDossier(){
 document.getElementById("newDossier").classList.toggle("hidden");
}

function createDossier(){
 fetch(API,{method:"POST",body:JSON.stringify({
 action:"new",
 nom:nd_nom.value,
 photo:nd_photo.value,
 discord:nd_discord.value
 })}).then(()=>location.reload());
}

function openForm(id){
 currentDossier=id;
 formEntry.classList.remove("hidden");
}

function closeForm(){
 formEntry.classList.add("hidden");
 entryType.value="";
 switchForm();
}

function switchForm(){
 formSoin.classList.add("hidden");
 formVaccin.classList.add("hidden");
 formVisite.classList.add("hidden");

 if(entryType.value==="soin") formSoin.classList.remove("hidden");
 if(entryType.value==="vaccin") formVaccin.classList.remove("hidden");
 if(entryType.value==="visite") formVisite.classList.remove("hidden");
}

function submitEntry(){
 let data={action:"add",id:currentDossier,type:entryType.value,auteur:user,data:{}};

 if(entryType.value==="soin"){
   data.data={
     blessures:blessures.value,
     interventions:interventions.value,
     invalidation:invalidation.value
   };
 }
 if(entryType.value==="vaccin"){
   if(permission!=="medic-chef") return alert("R√©serv√© medic-chef");
   data.data={
     nom:vaccin_nom.value,
     dose:vaccin_dose.value,
     but:vaccin_but.value
   };
 }
 if(entryType.value==="visite"){
   if(permission!=="medic-chef") return alert("R√©serv√© medic-chef");
   data.data={
     medecin:visite_medecin.value,
     date:visite_date.value,
     evaluation:visite_eval.value
   };
 }

 fetch(API,{method:"POST",body:JSON.stringify(data)})
 .then(()=>location.reload());
}

function logout(){
 localStorage.clear();
 location.href="login.html";
}
</script>

</body>
</html>
