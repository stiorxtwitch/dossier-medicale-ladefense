<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dossiers MÃ©dicaux</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
header{
  background:#020617;
  padding:15px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{padding:25px}
.card{
  background:#020617;
  padding:20px;
  border-radius:14px;
  margin-bottom:20px;
  box-shadow:0 0 20px rgba(0,0,0,.4);
}
button{
  background:#2563eb;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}
button:disabled{opacity:.6}
input,textarea,select{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:8px;
  border:none;
}
.entry{
  border-left:4px solid;
  padding:10px;
  margin-top:10px;
}
.soin{border-color:#dc2626}
.vaccin{border-color:#16a34a}
.visite{border-color:#ca8a04}
.badge{
  padding:3px 8px;
  border-radius:6px;
  font-size:12px;
  font-weight:bold;
}
.hidden{display:none}
</style>
</head>
<body>

<header>
  <div id="status"></div>
  <button onclick="logout()">DÃ©connexion</button>
</header>

<div class="container">
  <input id="search" placeholder="ðŸ”Ž Rechercher un dossier" oninput="render()">
  <br><br>
  <div id="list"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbyuOiBP0pv6cKeHIYVPGaq-MaMVU0nL64eg_Kxoict3H8YE6zx16-oefEPLuX8IbTw4/exec";
const user=localStorage.getItem("user");
const permission=localStorage.getItem("permission");
const viewer=localStorage.getItem("viewer");

let dossiers=[];

if(!user&&!viewer) location.href="login.html";
status.innerText=viewer?"ðŸ‘ï¸ Consultation citoyen":`ðŸ©º ${user} (${permission})`;

fetch(API,{method:"POST",body:JSON.stringify({action:"list"})})
.then(r=>r.json()).then(d=>{dossiers=d;render();});

function render(){
  list.innerHTML="";
  const q=search.value.toLowerCase();
  dossiers.filter(d=>d.nom.toLowerCase().includes(q))
  .forEach(d=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h2>${d.nom}</h2>
      <img src="${d.photo}" width="180"><br><br>
      ${d.entries.map(e=>{
        let c=e.contenu;
        if(e.type==="vaccin")
          return `<div class="entry vaccin">
            <span class="badge">ðŸ’‰ Vaccin</span><br>
            <b>${c.nom}</b> â€“ Dose ${c.dose}<br>
            But : ${c.but}
          </div>`;
        if(e.type==="soin")
          return `<div class="entry soin">
            <span class="badge">ðŸ©¹ Soin</span><br>
            Blessures : ${c.blessures}<br>
            Interventions : ${c.interventions}<br>
            Invalidation : ${c.invalidation||"â€”"}
          </div>`;
        if(e.type==="visite")
          return `<div class="entry visite">
            <span class="badge">ðŸ“‹ Visite mÃ©dicale</span><br>
            MÃ©decin : ${c.medecin}<br>
            Date : ${c.date}<br>
            Ã‰valuation : ${c.evaluation}
          </div>`;
      }).join("")}
    `;
    list.appendChild(div);
  });
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
