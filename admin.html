<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion des Paramédicaux</title>
<link rel="icon" href="https://i.imgur.com/ZtAo0te.png">
<style>
body{
  background:#0d1117;
  color:white;
  font-family:Arial;
  padding:20px;
}
h2{
  display:flex;
  align-items:center;
  gap:10px;
}
button{
  background:#238636;
  color:white;
  border:none;
  padding:8px;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#2ea043}
button.danger{
  background:#da1e28;
}
button.danger:hover{background:#f44336}
input,select,textarea{
  width:100%;
  padding:8px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #30363d;
  background:#0d1117;
  color:white;
}
textarea{resize:none;height:70px}
.paramedic{
  background:#161b22;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
}
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:10;
}
.box{
  background:#161b22;
  padding:20px;
  width:520px;
  max-height:85vh;
  overflow:auto;
  border-radius:12px;
}
.entry{
  padding:8px;
  border-radius:6px;
  margin-top:6px;
  font-size:14px;
}
.soin{background:#7d1f1f}
.vaccin{background:#1f3f7d}
.visite{background:#1f7d3a}
.label{
  display:inline-block;
  padding:4px 8px;
  border-radius:4px;
  margin:2px;
  font-size:12px;
}
.label-suture{background:#4caf50;color:white;} /* Vert pour Formation Suture */
.label-ecg{background:#2196f3;color:white;} /* Bleu pour Formation ECG */
.label-uae{background:#ff9800;color:white;} /* Orange pour UAE Complète */
.label-test{background:#673ab7;color:white;} /* Violet pour Test de médecine réussi */
.label-avert1{background:#ffeb3b;color:black;} /* Jaune pour Avertissement 1 */
.label-avert2{background:#f44336;color:white;} /* Rouge pour Avertissement 2 */
.loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
}
.loading img{
  width:120px;
}
</style>
</head>
<body>
<h2>
  <img src="https://i.imgur.com/ZtAo0te.png" width="40">
  Gestion des Paramédicaux
</h2>
<!-- BOUTON AJOUT (MEDIC CHEF SEULEMENT, ASSUME MODE MEDIC) -->
<div id="addZone"></div>
<div id="list"></div>
<!-- POPUP PARAMEDIC -->
<div class="popup" id="popup">
  <div class="box">
    <h3 id="popName"></h3>
    <img id="popImgId" width="150" alt="Carte d'identité"><br>
    <img id="popImgHead" width="150" alt="Photo identité"><br>
    <img id="popImgDiploma" width="150" alt="Diplôme"><br>
    <p id="popGrade"></p>
    <p id="popUser"></p>
    <div id="labels"></div>
    <h4>Interactions Médicales</h4>
    <div id="entries"></div>
    <div id="manageZone"></div>
    <button onclick="closePop()">Fermer</button>
  </div>
</div>
<!-- POPUP AJOUT PARAMEDIC -->
<div class="popup" id="addPop">
  <div class="box">
    <h3>Ajouter un membre paramédical</h3>
    <input id="a_nom" placeholder="Nom & Prénom du paramédic">
    <select id="a_grade">
      <option value="Médecin-Chef">Médecin-Chef</option>
      <option value="Médecin">Médecin</option>
      <option value="Infirmier Militaire">Infirmier Militaire</option>
      <option value="Aide-Infirmier Militaire">Aide-Infirmier Militaire</option>
      <option value="Stagiaire Infirmier Militaire">Stagiaire Infirmier Militaire</option>
    </select>
    <input id="a_user" placeholder="Username de la base de données">
    <input id="a_photo_id" placeholder="URL Imgur (carte d'identité)">
    <input id="a_photo_head" placeholder="URL Imgur (photo identité tête)">
    <input id="a_photo_diploma" placeholder="URL Imgur (diplôme de premier secours)">
    <button onclick="addParamedic()">Ajouter</button>
    <button onclick="closeAdd()">Annuler</button>
  </div>
</div>
<!-- LOADING -->
<div class="loading" id="loading">
  <img src="https://www.pngmart.com/files/23/Loading-PNG-Photos.gif">
</div>
<script>
const WEB_APP = "https://script.google.com/macros/s/AKfycbz86fNpd6GB8JIbHgTiz8FgpZiFj1c0Lbh62E0RXZwoINUB8ciUgztfYzZTvuQpAIXX/exec";
const mode = localStorage.mode || "medic"; // Assume medic for this page
let paramedics = [];
let dossiers = []; // To cache medical dossiers for interactions

/* ===== JSONP ===== */
function jsonp(p){
  return new Promise(r=>{
    const cb="cb_"+Math.random().toString(36).substring(2);
    p.callback=cb;
    window[cb]=d=>{r(d);delete window[cb];s.remove();}
    const s=document.createElement("script");
    s.src=WEB_APP+"?"+new URLSearchParams(p);
    document.body.appendChild(s);
  });
}

/* ===== LOADING ===== */
function showLoading(){
  loading.style.display="flex";
  setTimeout(()=>location.reload(),2000);
}

/* ===== LOAD ===== */
async function load(){
  paramedics = await jsonp({action:"list_paramedics"}); // Assume new action for paramedics list
  dossiers = await jsonp({action:"list"}); // Fetch medical dossiers to filter interactions
  list.innerHTML="";
  if(mode==="medic"){
    addZone.innerHTML = `
      <button onclick="openAdd()">➕ Ajouter un membre paramédical</button>
      <br><br>
    `;
  }
  paramedics.forEach(p=>{
    list.innerHTML += `
      <div class="paramedic" onclick="openPop('${p.id}')">
        ${p.nom} - ${p.grade}
      </div>
    `;
  });
}

/* ===== POP PARAMEDIC ===== */
function openPop(id){
  const p = paramedics.find(x=>x.id==id);
  popName.innerText = p.nom;
  popImgId.src = p.photo_id;
  popImgHead.src = p.photo_head;
  popImgDiploma.src = p.photo_diploma;
  popGrade.innerText = "Grade: " + p.grade;
  popUser.innerText = "Username: " + p.user;
  labels.innerHTML = "<h4>Étiquettes:</h4>";
  p.labels.forEach(l=>{
    const labelClass = l.toLowerCase().replace(/ /g,'-').replace(/é/g,'e').replace(/è/g,'e');
    labels.innerHTML += `<span class="label label-${labelClass}">${l}</span>`;
  });
  // Filter interactions from dossiers
  entries.innerHTML="";
  let userEntries = [];
  dossiers.forEach(d=>{
    d.entries.forEach(e=>{
      if(e.auteur === p.user){
        userEntries.push(e);
      }
    });
  });
  userEntries.forEach(e=>{
    entries.innerHTML+=`
      <div class="entry ${e.type}">
        <b>${e.type.toUpperCase()}</b><br>
        ${e.texte}<br>
        <small>${e.date} - Dans le dossier de ${dossiers.find(d=>d.id==e.dossierId).nom || 'Inconnu'}</small>
      </div>
    `;
  });
  if(mode==="medic"){
    manageZone.innerHTML=`
      <h4>Gestion</h4>
      <button class="danger" onclick="deleteParamedic('${id}')">Viré</button>
      <select id="newGrade">
        <option value="Médecin-Chef">Médecin-Chef</option>
        <option value="Médecin">Médecin</option>
        <option value="Infirmier Militaire">Infirmier Militaire</option>
        <option value="Aide-Infirmier Militaire">Aide-Infirmier Militaire</option>
        <option value="Stagiaire Infirmier Militaire">Stagiaire Infirmier Militaire</option>
      </select>
      <button onclick="promote('${id}')">Promouvoir</button>
      <select id="newLabel">
        <option value="Formation Suture">Formation Suture</option>
        <option value="Formation ECG">Formation ECG</option>
        <option value="UAE Complète">UAE Complète</option>
        <option value="Test de médecine réussi">Test de médecine réussi</option>
        <option value="Avertissement 1">Avertissement 1</option>
        <option value="Avertissement 2">Avertissement 2</option>
      </select>
      <button onclick="addLabel('${id}')">Ajouter une étiquette</button>
    `;
  }else manageZone.innerHTML="";
  popup.style.display="flex";
}
function closePop(){ popup.style.display="none"; }

/* ===== ADD PARAMEDIC ===== */
function openAdd(){ addPop.style.display="flex"; }
function closeAdd(){ addPop.style.display="none"; }
function addParamedic(){
  jsonp({
    action:"new_paramedic",
    nom:a_nom.value,
    grade:a_grade.value,
    user:a_user.value,
    photo_id:a_photo_id.value,
    photo_head:a_photo_head.value,
    photo_diploma:a_photo_diploma.value
  }).then(showLoading);
}

/* ===== MANAGE ===== */
function deleteParamedic(id){
  if(confirm("Confirmer la suppression ?")){
    jsonp({
      action:"delete_paramedic",
      id
    }).then(showLoading);
  }
}
function promote(id){
  jsonp({
    action:"promote",
    id,
    newGrade:newGrade.value
  }).then(showLoading);
}
function addLabel(id){
  jsonp({
    action:"add_label",
    id,
    label:newLabel.value
  }).then(showLoading);
}

load();
</script>
<a href="https://stiorxtwitch.github.io/dossier-medicale-ladefense/guide.html" target="_blank">Guide</a>
</body>
</html>
