<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dossiers</title>
<style>
body{background:#0d1117;color:white;font-family:Arial;padding:20px}
.card{background:#161b22;padding:15px;border-radius:10px;margin-bottom:10px}
button{padding:6px}
</style>
</head>
<body>

<h2>Dossiers médicaux</h2>

<input id="nom" placeholder="Nom">
<input id="photo" placeholder="Photo URL">
<button onclick="newDossier()">Créer dossier</button>

<div id="list"></div>

<script>
const WEB_APP="https://script.google.com/macros/s/AKfycbwdBvKtH8-PWY8ofofan8v9qJXLDrmztzAODRmgpj3qDSLWvB60SJY1lCYpLMLavu4/exec";
const user=localStorage.user||"inconnu";

function jsonp(p){
  return new Promise(r=>{
    const cb="cb"+Math.random();
    p.callback=cb;
    window[cb]=d=>{r(d);delete window[cb];};
    const s=document.createElement("script");
    s.src=WEB_APP+"?"+new URLSearchParams(p);
    document.body.appendChild(s);
  });
}

async function load(){
  const d=await jsonp({action:"list"});
  list.innerHTML="";
  d.forEach(x=>{
    let h=`<div class="card"><b>${x.nom}</b>`;
    x.entries.forEach(e=>{
      h+=`<div>${e.type} – ${e.auteur} – ${e.date}</div>`;
    });
    h+=`
    <input placeholder="Type" id="t${x.id}">
    <input placeholder="Texte" id="c${x.id}">
    <button onclick="add('${x.id}')">Ajouter</button>
    </div>`;
    list.innerHTML+=h;
  });
}

function newDossier(){
  jsonp({action:"new", nom:nom.value, photo:photo.value}).then(load);
}

function add(id){
  jsonp({
    action:"add",
    id,
    type:document.getElementById("t"+id).value,
    text:document.getElementById("c"+id).value,
    user
  }).then(load);
}

load();
</script>
</body>
</html>
